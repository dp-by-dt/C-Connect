{% extends "base.html" %}

{% block extra_css %}
<style>
/* ==================== CAMPUS BOARD LAYOUT ==================== */
.board-container {
    max-width: 720px;
    margin: 0 auto;
    padding: 2rem 1rem;
    animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== Header ===== */
.board-header {
    margin-bottom: 2.5rem;
}

.board-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.board-title-icon {
    font-size: 2rem;
}

.board-subtitle {
    color: var(--text-tertiary);
    font-size: 0.9375rem;
    margin: 0;
    line-height: 1.5;
}

/* ===== Create Post Card ===== */
.create-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
}

.create-card:hover {
    box-shadow: var(--shadow-md);
}

.create-card-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 1.25rem 0;
}

.create-textarea {
    width: 100%;
    min-height: 100px;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9375rem;
    font-family: inherit;
    resize: vertical;
    transition: all var(--transition-base);
    margin-bottom: 1rem;
}

.create-textarea::placeholder {
    color: var(--text-muted);
}

.create-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    background: var(--bg-primary);
    box-shadow: 0 0 0 4px rgba(26, 77, 46, 0.1);
}

.create-inputs-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.create-input {
    padding: 0.875rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: all var(--transition-base);
}

.create-input::placeholder {
    color: var(--text-muted);
}

.create-input:focus {
    outline: none;
    border-color: var(--primary-color);
    background: var(--bg-primary);
    box-shadow: 0 0 0 4px rgba(26, 77, 46, 0.1);
}

.create-expires {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
}

.create-expires-label {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    font-weight: 500;
}

.create-expires-input {
    width: 100px;
    padding: 0.625rem 0.875rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9375rem;
    transition: all var(--transition-base);
}

.create-expires-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(26, 77, 46, 0.1);
}

.create-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.create-btn {
    flex: 1;
    padding: 0.875rem 2rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
}

.create-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.create-btn:active {
    transform: translateY(0);
}

.create-error {
    color: var(--danger-color);
    font-size: 0.875rem;
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    background: rgba(198, 61, 61, 0.1);
    border: 1px solid rgba(198, 61, 61, 0.2);
    border-radius: var(--radius-md);
    display: none;
}

.create-error.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== Posts List ===== */
.posts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.post-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    animation: slideIn 0.4s ease;
}

.post-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.post-content {
    color: var(--text-primary);
    font-size: 1rem;
    line-height: 1.6;
    margin: 0 0 1rem 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-subtle);
}

.post-meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: var(--bg-hover);
    border-radius: var(--radius-full);
    font-size: 0.8125rem;
    color: var(--text-tertiary);
    font-weight: 500;
}

.post-meta-item i {
    font-size: 0.875rem;
}

.post-expires {
    color: var(--text-muted);
    font-size: 0.8125rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.post-expires i {
    color: var(--warning-color);
}

.post-actions {
    display: flex;
    gap: 0.75rem;
}

.post-btn {
    padding: 0.625rem 1.25rem;
    background: var(--bg-hover);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.post-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.post-btn-like {
    color: var(--text-primary);
}

.post-btn-like:hover {
    color: #e74c3c;
    border-color: #e74c3c;
}

.post-btn-like.liked {
    background: rgba(231, 76, 60, 0.1);
    border-color: #e74c3c;
    color: #e74c3c;
}

.post-btn-delete {
    color: var(--danger-color);
    margin-left: auto;
}

.post-btn-delete:hover {
    background: rgba(198, 61, 61, 0.1);
    border-color: var(--danger-color);
}

/* ===== Empty State ===== */
.empty-state {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-xl);
    padding: 3rem 2rem;
    text-align: center;
    display: none;
}

.empty-state.show {
    display: block;
    animation: fadeIn 0.6s ease;
}

.empty-state-icon {
    font-size: 3.5rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state-text {
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin: 0;
}

/* ===== Character Counter ===== */
.char-counter {
    text-align: right;
    font-size: 0.8125rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}

.char-counter.warning {
    color: var(--warning-color);
}

.char-counter.danger {
    color: var(--danger-color);
    font-weight: 600;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
    .board-container {
        padding: 1.5rem 1rem;
        padding-bottom: calc(var(--bottom-nav-height) + 1rem);
    }

    .board-title {
        font-size: 1.5rem;
    }

    .create-card {
        padding: 1.5rem;
    }

    .create-inputs-row {
        grid-template-columns: 1fr;
    }

    .post-card {
        padding: 1.25rem;
    }

    .post-actions {
        flex-wrap: wrap;
    }

    .post-btn {
        flex: 1;
        justify-content: center;
        min-width: 100px;
    }

    .post-btn-delete {
        flex: 1;
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .board-container {
        padding: 1.25rem 0.75rem;
    }

    .create-card,
    .post-card {
        border-radius: var(--radius-md);
    }
}
</style>
{% endblock %}

{% block body %}
<div class="board-container">
    <!-- Header -->
    <header class="board-header">
        <h1 class="board-title">
            <span class="board-title-icon">ðŸ“Œ</span>
            Campus Board
        </h1>
        <p class="board-subtitle">
            Share short, time-bound campus updates. Posts expire automatically to keep the board fresh and relevant.
        </p>
    </header>

    <!-- Create Post Card -->
    <div class="create-card glass-effect">
        <h3 class="create-card-title">Create Update</h3>

        <textarea 
            id="content" 
            class="create-textarea"
            maxlength="300"
            placeholder="What's happening on campus?"
            oninput="updateCharCounter()"></textarea>
        
        <div class="char-counter" id="charCounter">0 / 300</div>

        <div class="create-inputs-row">
            <input 
                id="department" 
                class="create-input"
                type="text"
                placeholder="Department (optional)">
            
            <input 
                id="location" 
                class="create-input"
                type="text"
                placeholder="Location (optional)">
        </div>

        <div class="create-expires">
            <label class="create-expires-label" for="expires">
                <i class="bi bi-clock"></i>
                Expires in (hours):
            </label>
            <input 
                id="expires" 
                class="create-expires-input"
                type="number" 
                min="1" 
                max="120" 
                value="24">
        </div>

        <div class="create-actions">
            <button class="create-btn" onclick="createPost()">
                <i class="bi bi-send"></i>
                Post Update
            </button>
        </div>

        <div class="create-error" id="createError"></div>
    </div>

    <!-- Posts List -->
    <div class="posts-list" id="posts"></div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">ðŸ“­</div>
        <p class="empty-state-text">No active campus updates</p>
    </div>
</div>

<script>
// Character counter
function updateCharCounter() {
    const textarea = document.getElementById('content');
    const counter = document.getElementById('charCounter');
    const length = textarea.value.length;
    
    counter.textContent = `${length} / 300`;
    
    counter.classList.remove('warning', 'danger');
    if (length > 250) {
        counter.classList.add('warning');
    }
    if (length >= 290) {
        counter.classList.add('danger');
    }
}

// Fetch and display posts
function fetchPosts() {
    fetch("/campus-board/list")
        .then(res => res.json())
        .then(posts => {
            const container = document.getElementById("posts");
            const emptyState = document.getElementById("emptyState");

            container.innerHTML = "";

            if (posts.length === 0) {
                emptyState.classList.add('show');
                return;
            }

            emptyState.classList.remove('show');

            posts.forEach(p => {
                const card = document.createElement("div");
                card.className = "post-card glass-effect";

                // Format expiry time
                const expiryDate = new Date(p.expires_at);
                const now = new Date();
                const hoursLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60));
                
                let expiryText = expiryDate.toLocaleString();
                if (hoursLeft <= 24) {
                    expiryText += ` (${hoursLeft}h left)`;
                }

                // Build meta tags
                let metaHTML = '';
                if (p.department) {
                    metaHTML += `
                        <span class="post-meta-item">
                            <i class="bi bi-building"></i>
                            ${p.department}
                        </span>
                    `;
                }
                if (p.location) {
                    metaHTML += `
                        <span class="post-meta-item">
                            <i class="bi bi-geo-alt"></i>
                            ${p.location}
                        </span>
                    `;
                }

                card.innerHTML = `
                    <p class="post-content">${escapeHtml(p.content)}</p>

                    ${metaHTML ? `<div class="post-meta">${metaHTML}</div>` : ''}

                    <div class="post-expires">
                        <i class="bi bi-hourglass-split"></i>
                        Expires: ${expiryText}
                    </div>

                    <div class="post-actions">
                        <button class="post-btn post-btn-like ${p.is_liked ? 'liked' : ''}" onclick="toggleLike(${p.id})">
                            <i class="bi bi-heart${p.is_liked ? '-fill' : ''}"></i>
                            <span>${p.likes}</span>
                        </button>
                        
                        ${p.is_owner ? `
                            <button class="post-btn post-btn-delete" onclick="deletePost(${p.id})">
                                <i class="bi bi-trash"></i>
                                Delete
                            </button>
                        ` : ''}
                    </div>
                `;

                container.appendChild(card);
            });
        })
        .catch(error => {
            console.error('Error fetching posts:', error);
        });
}

// Create new post
function createPost() {
    const content = document.getElementById("content").value.trim();
    const department = document.getElementById("department").value.trim();
    const location = document.getElementById("location").value.trim();
    const expires = document.getElementById("expires").value;
    const errorBox = document.getElementById("createError");

    errorBox.classList.remove('show');
    errorBox.textContent = '';

    if (!content) {
        errorBox.textContent = "Content cannot be empty.";
        errorBox.classList.add('show');
        return;
    }

    fetch("/campus-board/create", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            content,
            department: department || null,
            location: location || null,
            expires_in_hours: parseInt(expires)
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            errorBox.textContent = data.error || "Failed to create post.";
            errorBox.classList.add('show');
            return;
        }

        // Clear form
        document.getElementById("content").value = "";
        document.getElementById("department").value = "";
        document.getElementById("location").value = "";
        document.getElementById("expires").value = "24";
        updateCharCounter();

        // Refresh posts
        fetchPosts();
    })
    .catch(error => {
        errorBox.textContent = "Network error. Please try again.";
        errorBox.classList.add('show');
        console.error('Error creating post:', error);
    });
}

// Toggle like
function toggleLike(id) {
    fetch(`/campus-board/like/${id}`, { 
        method: "POST" 
    })
    .then(() => fetchPosts())
    .catch(error => {
        console.error('Error toggling like:', error);
    });
}

// Delete post
function deletePost(id) {
    if (!confirm("Are you sure you want to delete this post?")) {
        return;
    }

    fetch(`/campus-board/delete/${id}`, { 
        method: "DELETE" 
    })
    .then(() => fetchPosts())
    .catch(error => {
        console.error('Error deleting post:', error);
    });
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    fetchPosts();
    updateCharCounter();
});

// Auto-refresh every 30 seconds
setInterval(fetchPosts, 30000);
</script>
{% endblock %}